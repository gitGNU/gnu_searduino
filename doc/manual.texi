\input texinfo   @c -*-texinfo-*-

@c %**start of header
@setfilename architecture.texi
@settitle Searduino - Manual
@c %**end of header
@afourpaper
@c @setchapternewpage odd

@include version.texi


@c Put everything in one index (arbitrarily chosen to be the concept index).
@syncodeindex fn cp
@syncodeindex ky cp
@syncodeindex pg cp
@syncodeindex vr cp


@titlepage
@sp 10
@c omment The title is printed in a large font
@c @center @titlefont{Searduino Manual}


@c @page
@vskip 0pt plus 1filll
@title Searduino Manual
@subtitle C/C++ environment
@subtitle Stubs
@subtitle Simulator
@subtitle ... for Arduino
@subtitle 
@subtitle Version: @value{VERSION} 
@subtitle Date: @value{UPDATED} 
@author Henrik Sandklef
@include searduino_copying
@end titlepage

@c @titlepage
@c @title Searduino - Manual
@c @subtitle January 2012
@c @end titlepage


@contents

@chapter Introduction
@include introduction.texi

@chapter Background
@include background.texi

@chapter Abbreviations
@include abbrevs.texi

@chapter Supported boards and platforms
@include supported.texi

@include download.texi

@chapter Using Searduino

In the previous chapter we looked a bit at the digpins example, so we
now have some feeling for what a Searduino Makefile contains. We will
now proceed by writing our first Arduino program using Searduino.

@section Writing the first program

@subsection The first C file
@*
@*
Open up your favorite editor (emacs?) and begin....
@*
@*
To use the Arduino functionality you need to include Arduino.h and searduino.h, so
we need to add this to our file:
@*
@*
@code{#include <Arduino.h>}
@*
@code{#include <searduino.h>}
@*
@*
@*
When using Arduino IDE you've seen the @code{loop} function as the
starting point for the program. With Searduino we're back to the
normal C way of doing this with a @code{main} function, so we need to define a main function.
@*
@*
@code{int main(void)}
@{
@}
@*
@*
As with the loop function you're writing when you're using the Arduino IDE,
the main function needs to never exit or return. It's a simple control
loop (see @uref{http://en.wikipedia.org/wiki/Embedded_system#Simple_control_loop}).
@*
@*
So a very simple main function looks like this
@*
@*
@code{#include <Arduino.h>}
@*
@code{#include <searduino.h>}
@*
@*
@*
@code{int main(void)}
@*
@{
@*
@code{  for(;;)}
@*
@code{    }
@{
@*
@code{init();}
@*
@*
@code{       digitalWrite(13, 1);}
@*
@code{       delay(100);}
@*
@code{       digitalWrite(13, 0);}
@*
@code{       delay(100);}
@*
@code{   }
@}
@*
@}
@*
@*
@*
@i{Note: this program sets pin 13 high and low with 0.1 secs
interval. You don't need to connect a led to output pin 13, since
pin 13 already has a built in led on the board.}

@subsection Write the first Makefile

@b{Inporant settings in the Makefile}
@itemize @bullet
@item SEARDUINO_PATH - should be set to the directory of your
Searduino installation
@item PROG - name of the program to build
@item SHLIB - name of the shared library to build
@item SRC_C - a list (separated with space) of C files to compile
@item SRC_CXX - a list (separated with space) of C++ files to compile
@item ARDUINO - should be set to the type of software you want to
build (see @b{Build types} below)
@end itemize
@*
@*
@b{Include the searduino makefile}
@*
You need to include some settings, targets and rules from
Searduino. This is done by adding the following line to your Makefile.
@*
@*
@code{include $(SEARDUINO_PATH)/share/searduino/mk/searduino.mk}
@*
@*
@*
A Makefile to build the code above can look like this:
@*
@*
@code{SEARDUINO_PATH=/opt/searduino/}
@*
@code{SRC_C=seardex.c}
@*
@code{SRC_CXX=}
@*
@code{ARDUINO=stub}
@*
@code{PROG=seardex}
@*
@code{SHLIB=seardex.so}
@*
@code{include $(SEARDUINO_PATH)/share/searduino//mk/searduino.mk}
@*
@*



@i{Note: You don't have to use the makefiles provided by Searduino. The
makefiles do however provide a lot of help (board settings etc).}



@subsection Building the program for PC
To build your software to be executed on your PC:

make sure the the variable @b{ARDUINO} in the Makefile is set to
@b{stub}.


 and type:
@*
@*
@code{make clean}
@*
@code{make prog}
@*

To run the program
@*
@*
@code{./seardex}


@subsection Building a shared library for use in the simulators
To build your software to be executed on your PC:
make sure the the variable @b{ARDUINO} in the Makefile is set to
@b{stub}.

 and type:
@*
@*
@code{make clean}
@*
@code{make shlib}
@*
@*
To run the code in the stream simulator
@*
@*
@code{/opt/searduino/bin/searduino-stream-sim --arduino-code ./seardex.so}
@*
@*
To run the code in the Pardon simulator
@*
@*
@code{/opt/searduino/bin/searduino-pardon.sh --arduino-code ./seardex.so}


@subsection Building the program for UNO
To build your software to be executed on your PC:

make sure the the variable @b{ARDUINO} in the Makefile is set to
@b{uno} and type:
@*
@*
By setting ARDUINO to uno the Searduino makefiles will use the
settings for building and uploading for the Arduino UNO board. 
@*
To build the program, all we have to do now is to type:
@*
@*
@code{make clean}
@*
@code{make prog}
@*
@*
@*
To upload and run the program on the Arduino UNO board:
@*
@*
@code{make upload}
@*
@*
You should now be able to see the built in led (pin 13) flash. If not,
the author of this document need to his homework.


@include testing.texi

@chapter Build for different targets

With Searduino it's (relatively) easy to compile your program for
various boards. You decide what targets to build for with the ARDUINO
variable in the Makefile. The following values of that variable are implemented.

@b{Build types}
@itemize @bullet
@item uno - builds software for the Arduino UNO board
@item mega - builds software for the Arduino Mega board
@item due - builds software for the Arduino Mega board
@item stub - builds software for the PC
@end itemize

@chapter Various Searduino functions/macros
Searduino provides a small set of macros for you. When building for
your local computer they are enabled, and when building for the
Arduino hw they are disabled.

@multitable  @columnfractions .0 .30 .70
@item 
@tab @b{Macro}
@tab @b{Description}
@item
@tab @code{SEARDUINO_LOOP}
@tab On the Arduino boards this is the same as a for loop
(@code{for(;;)}). When using this macro your code can be paused in the simulator.
@item
@tab more will come
@tab and will be secribed....
@end multitable



@section print functions/macros
@*
If you want to print out strings when build your code for local use (not
on an Arduino board) and have the printouts disabled when building for
Arduino you can use the following macro:
@*
@*
@code{SEARDUINO_DEBUG((msg))}
@*
@*
The macro (if not building for Arduino boards) takes what is inside
the parenthesies and passes that to printf. It does a bit more than
that, put put simply, that's what it does.
@*
Example use:
@*
@code{SEARDUINO_DEBUG(("The variable x is:%d",x));}
@*
 
@*
@*
@i{Note #1: You must use double paranthesises.} 
@*
@i{Note #2: The macro is defined in print.h}
@*
@*




@section pause/resume macros 
@*
coming soon

@chapter Simulators

With Searduino you can easily build your code for use with:

@itemize @bullet
@item stubed program - the Arduino fuctions print when they are being called
(stdout by default)
@item stream - same as with stub, but now also with a listening
(stdin) thread to which you can send commands (such as settig digital input
pin 2 to 1).
@item pardon - a Simulator, written in Python, using the Python
simulator interface (pearduino)
@item python scripts - your own Python scripts, using the Python
simulator interface (pearduino)
@item xxxx - a simulator, written in C++/Qt/Qml.
simulator interface - more info soon
@end itemize
How to use each of the above is explained below in separate sections.

@section Stub 
Use this way if you want to run your program stand alone, with no way
of giving input to it. As soon as your program sets a pin you will see
a printout on stdout.

To build a stand alone stubed program set the following variables in
your @code{Makefile} (before you include @code{searduino.mk}):
@*
@code{ARDUINO=stub}
@*
@code{PROG=somename}
@*
@i{Note: You must NOT have the variable SHLIB set in the Makefile}

Check out the example as found in
@code{example/python-digcounter}. Edit the Makefile
(@code{Makefile.digcounter}) and make sure to set the variables as
described above. After you're done, type:
@*
@code{make -f Makefile.digcounter clean}
@*
@code{make -f Makefile.digcounter}
@*
and possibly also
@*
@code{make -f Makefile.digcounter check}



@subsection Stub output syntax

With this mode set Searduino print messages to a stream (default to
stdout) for the function calls where some hardware is set. 
@*
@*
You switch on and off this mode as many times you want during execution using the functions:
@*
@code{void searduino_enable_streamed_output(void)}
@*
@code{void searduino_disable_streamed_output(void)}

@multitable  @columnfractions .0 .30 .20 .50
@item 
@tab @b{Directive}
@tab @b{Example}
@tab @b{Description}

@item
@tab @code{dpin:<pin>:<value>}
@tab @code{dpin:1:0}
@tab Digital output pin 1 is 0

@item
@tab @code{dmode:<pin>:<mode>}
@tab @code{dpin:1:0}
@tab Mode of digital pin 1 is 0

@item
@tab @code{apin:<pin>:<value>}
@tab @code{apin:2:1.123}
@tab Analogue pin 2 is 1.123

@end multitable


@section Streamed simulator
With the program searduino-stream-sim you can test your Arduino
program and give input data to it using stdin. 

@subsection Preparing your arduino code for the simulator
First of all you must build your Arduino code as a shared library. To
do this you must set the following variables in your @code{Makefile}
(before you include @code{searduino.mk}):

@* 
@code{ARDUINO=stub} 
@*
@code{SHLIB=libyourcode.so} 
@*
@*
@i{Note: You must NOT have the variable PROG set in the Makefile}

After this you must do a clean build:

@code{make -f Makefile.digcounter clean}
@*
@code{make -f Makefile.digcounter}
@*
@*

@subsection Preparing the simulator
Next thing to do is to make sure that your system can find all the
shared libraries. Type:

@*
@code{export LD_LIBRARY_PATH=/opt/searduino/lib}
@*
@*

By doing this we tell the system to look for libraries in
@code{/opt/searduino/lib}, which is where we assume you've installed
searduino in.

@*

We're now ready to launch the simulator, but let's do a quick check
before we proceed. Let's verify that the dynamic loader will find all
the libraries needed by pearduino (Searduino's Python library). On
GNU/Linux and similar system do:
@*
@code{ldd /opt/searduino/lib/pearduino.so}
@*

We are, as before, assuming you've installed Searduino in
/opt/searduino. ldd (a tool to print out dynamic link dependencies)
will print out a list of the libraries pearduino depends on. Make sure
that you see no printouts waring you of missing libraries (ldd reports
this by saying ``not found''). 

@*
If this went ok, we're finally ready to proceed by invoking pardon.

@subsection Launching the simulator
You need to pass the arduino code to load by using command line
arguments, here how to do it:
@*
@code{/opt/searduino/bin/searduino-stream-sim --arduino-code /some/dir/libyourcode.so}
@*


@subsection Streamed simulator input syntax

@multitable  @columnfractions .0 .30 .20 .50
@item 
@tab @b{Directive}
@tab @b{Example}
@tab @b{Description}

@item
@tab @code{dpin:<pin>:<value>}
@tab @code{dpin:13:1}
@tab Set digital pin 13 to 1

@item
@tab @code{apin:<pin>:<value>}
@tab @code{apin:7:1.123}
@tab Set analogue pin 7 to 1.123

@end multitable


@subsection Scripting with bash
TBD
@subsection Scripting over the network
TBD

@section Pardon simulator
With Searduino you can test your Arduino program in the Python
simulator (written in Python using Gtk). 

@subsection Preparing your arduino code for the simulator
The procedure for doing this is the same as described in the section
``Streamed simulator''

@subsection Setting up the Python environment
Now, the shared library is ready for use by python. It's almost time
to start the simulator. But there's some few more things to do before
we're there. First, we must tell Python where to look for the
Searduino Python library called Pearduino. Using bash, as most do on
GNU/Linux, BSD, cygwin systems, you type:

@*
@code{export PYTHONPATH=/opt/searduino/lib}
@*
assuming you've installed Searduino in @i{/opt/searduino/}. 

@* 


@subsection Preparing the simulator
The procedure for doing this is the same as described in the section
``Streamed simulator''

@subsection Launching the simulator

@*
@*
@code{/opt/searduino/bin/pardon}
@*

Pardon will ask you to point to the shared library containing the
arduino code you want to execute in the simulator. Browse your way to
the file and click ok. Now pardon should be executing your binary.

If you want to pass the arduino code to load by using command line
arguments, here how to do it:
@*
@code{/opt/searduino/bin/pardon --arduino-code /some/dir/libyourcode.so}
@*


@section Python scripts
With Searduino you can write test code for your Arduino program in
Python. Searduino comes with a Python library, called pearduino, for
this. 

Until we've written this section, we refer to the example @code{example/python-digcounter/simple-hw.py}.

@section xxx simulator

@chapter Using Arduino examples

Searduino comes with a program, called arduino-ex2c, the can convert
an Arduino example (.ino) to a C file that you compile with
Searduino. Searduino also comes with all the Arduino examples.
@* 
Let's assume you want to work with the Arduino example called Blink
and that you want to create a shared library (for use in the
simulators). Do the the following:
@*
@*
@code{/opt/searduino/bin/arduino-ex2c --shlib --searduino-path /opt/searduino/ \}
@*
@code{  /opt/searduino/share/examples/arduino/1.Basics/Blink/}
@*
@*
If you want a stand alone program instead, do:
@*
@code{/opt/searduino/bin/arduino-ex2c --prog --searduino-path /opt/searduino/ \}
@*
@code{  /opt/searduino/share/examples/arduino/1.Basics/Blink/}
@*
@*
If you want to build for Uno instead, do:
@*
@code{/opt/searduino/bin/arduino-ex2c --uno --searduino-path /opt/searduino/ \}
@*
@code{  /opt/searduino/share/examples/arduino/1.Basics/Blink/}
@*

You should now have a directory called Blink. Go to this dorectory and
type:
@*
@code{make}
@*


@i{Note: If you only want to create the C file, simply pass the ino file insetad the directoy.}


@include libraries.texi

@chapter Debugging Arduino code

@chapter Examples
@include examples.texi


@chapter Write your own simulator
@subsection Writing a simulator in C/C++ 



@subsection Writing local tests in Python
For now, we would like to refer to pardon in the Searduino source
treee for en example on how to write a simulator in Python.


@chapter Future and possible enhancements
@include future.texi

@bye


